---
title: "SPER-vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SPER-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup}
library(SPER)
##  Other necessary libraries
library(Seurat)
# library(dplyr)
```

# Example: adult mouse brain spatial transciptomics dataset

## Dataset
- We have provided a small example where you have 37 genes across 2695 spots in the spatial transcriptomics (ST) data 'ST_expression_data'. We also included the physical coordinates of all these spots as 'ST_coordinates'. 
  
```{r}
####  Spatial transcriptomics data
head(ST_expression_data)

####  Coordinates & Distance matrix
head(ST_coordinates)
spot_dist <- as.matrix(dist(ST_coordinates))
round_dist_mat <- ceiling(spot_dist / 120) * 120
round_dist_mat[which(round_dist_mat > 1800)] <- 1800
```

- If wanted, one can plot the gene's spatial distribution among the spots using 'gg_gene' function

```{r}
gg_gene("Grp",
        ST_expression_data,
        coord = ST_coordinates,
        title.anno = "Gene")
```

- Another important component of SPER is the cell-type spatial compositional data. Usually, one can get them by using cell type decomposition algorithms on a ST dataset. Here we just provide the results which is obtained from RCTD algorithms (now as a part of spacexr).

```{r}
####  spatial compositional data
head(spatial_comp_data)
```


## SPER: 
- With given data, we can run SPER and get the outcome as a list. The list has each gene as the name of an element where it actually contains the spatial paired expression matrix between the gene and all cell types. 

```{r}
res <- SPER(dist.mat = round_dist_mat,
            dist.list = (0:15)*120,
            ST.mat = ST_expression_data,
            CoDa.data = spatial_comp_data)
res[["L2.3.IT"]][1:10, 1:10]
```

- Above results shows the SPER between L2/3 IT cell type and all genes. For example, for the 1st column, the values represents the spatial association between *Grp* and L2/3 IT cells at the given distance (0, 120 microns, 240 microns, etc.). Higher value means the gene is spatially more associated with the cells. 

- However, it will be impractical to compare the whole column between pairs. Therefore, we can apply a customized weight on the column so that we can integrate the values into one score, which is SPER score.

```{r}
# custom_weights <- c(rep(1/5, 5), rep(0, 11))
custom_weights <- c(0, 0, rep(1/3, 3), rep(0, 11))
SPER_res <- weightSPER(res,
                       custom_weights)
head(SPER_res)
```

- After applying the weight, we can finally get the matrix of SPER scores for each gene/cell-type pair. In the matrix, the values represent, depending the weights you have applied, the strength of spatial relationship between the gene and cells. In our example, we used the 'paracrine' weight which has its focus on the distance of 240, 360, and 480 microns.


